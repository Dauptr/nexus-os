<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXUS AI // NEURAL INTERFACE</title>
    
    <!-- PWA / METADATA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23000'/><circle cx='16' cy='16' r='10' fill='%2300e5ff'/><path d='M16 6v20M6 16h20' stroke='%23000' stroke-width='4'/></svg>">

    <!-- LIBRARIES -->
    <!-- Note: For production, replace the script below with <link href="./output.css" rel="stylesheet"> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;600&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- Markdown & Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(10, 10, 15, 0.85);
            --glass-border: rgba(0, 229, 255, 0.3);
            --accent-primary: #00e5ff; /* Cyan */
            --accent-secondary: #0077ff;
            --msg-user-bg: linear-gradient(135deg, #00e5ff 0%, #0077ff 100%);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --font-mono: 'Rajdhani', monospace;
            --font-header: 'Orbitron', sans-serif;
            --nx-border: #2a2f3a;
        }

        body {
            background: #000;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
            background: radial-gradient(circle at center, #0a1128 0%, #000000 100%);
            height: 100dvh; 
            width: 100vw;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; box-shadow: 0 0 10px var(--accent-primary); }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }

        /* Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.1), inset 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .font-header { font-family: var(--font-header); letter-spacing: 0.1em; }
        .font-mono { font-family: var(--font-mono); }
        
        .input-glow:focus-within {
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4), inset 0 0 15px rgba(0, 229, 255, 0.15);
            border-color: rgba(0, 229, 255, 1);
            background: rgba(0, 20, 40, 0.6);
        }

        /* Animations */
        @keyframes scanline-move {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes pulse-cyan {
            0%, 100% { box-shadow: 0 0 5px var(--accent-primary); }
            50% { box-shadow: 0 0 25px var(--accent-primary), 0 0 15px var(--accent-secondary); }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 9998; opacity: 0.15; animation: scanline-move 10s linear infinite;
        }
        .msg-anim { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .active-ring { animation: pulse-cyan 2s infinite; }

        /* Boot Screen */
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 1s ease; }
        .loader-ring { width: 100px; height: 100px; border: 4px solid #000; border-top: 4px solid var(--accent-primary); border-right: 4px solid var(--accent-secondary); border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(0, 229, 255, 0.5); }

        /* Media Deck */
        .media-overlay { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(30px); width: 95%; max-width: 600px; z-index: 40; opacity: 0; pointer-events: none; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .media-overlay.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        
        /* Radio & Video */
        .radio-genres { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .genre-chip { white-space: nowrap; padding: 6px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; font-size: 11px; color: #a5f3fc; cursor: pointer; transition: all 0.2s; font-family: var(--font-mono); text-transform: uppercase; }
        .genre-chip:hover, .genre-chip.active { background: rgba(0, 229, 255, 0.2); border-color: #00e5ff; color: white; box-shadow: 0 0 15px rgba(0, 229, 255, 0.4); transform: translateY(-2px); }
        .station-list { max-height: 250px; overflow-y: auto; margin-top: 12px; }
        .station-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; border-radius: 8px; }
        .station-item:hover { background: rgba(255,255,255,0.05); }
        .station-item.playing { background: rgba(0, 229, 255, 0.1); border-left: 3px solid #00e5ff; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
        .video-container { background: #000; border-radius: 12px; overflow: hidden; position: relative; aspect-ratio: 16/9; border: 1px solid rgba(0, 229, 255, 0.4); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .video-container.local { border-color: #00e5ff; box-shadow: 0 0 20px rgba(0, 229, 255, 0.3); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* IDE Styles */
        #code-editor-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0, 0, 0, 0.98); display: none; flex-direction: column; backdrop-filter: blur(15px); }
        #code-editor-overlay.active { display: flex; }
        .editor-body { display: grid; grid-template-columns: 1fr 1fr 350px; flex: 1; overflow: hidden; height: 100%; gap: 1px; background: #333; }
        @media (max-width: 1024px) { .editor-body { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr; } #copilot-panel { border-top: 1px solid #333; border-left: none; } }
        @media (max-width: 768px) { .editor-body { display: flex; flex-direction: column; } #code-area { flex: 0 0 45%; min-height: 250px; } #preview-area { flex: 1; border-top: 1px solid #333; } #copilot-panel { display: none; } }

        .editor-col { background: #0d1117; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #code-area { background: #0d1117; color: #c9d1d9; font-family: var(--font-mono); font-size: 13px; padding: 1.5rem; border: none; resize: none; outline: none; width: 100%; height: 100%; line-height: 1.6; }
        #preview-area { background: #fff; position: relative; }
        #preview-frame { width: 100%; height: 100%; border: none; }
        
        #copilot-panel { background: #0d1117; border-left:1px solid #30363d; display: flex; flex-direction: column; }
        .copilot-header { padding: 12px; border-bottom: 1px solid #30363d; background: rgba(0, 229, 255, 0.1); color: #00e5ff; font-size: 11px; font-bold; font-family: var(--font-header); display: flex; justify-content: space-between; align-items: center; letter-spacing: 1px; }
        .copilot-chat { flex: 1; overflow-y: auto; padding: 12px; font-size: 12px; color: #c9d1d9; font-family: var(--font-mono); }
        .copilot-input-area { padding: 12px; border-top: 1px solid #30363d; background: #050505; display: flex; gap: 8px; }
        .copilot-input { flex: 1; background: #161b22; border: 1px solid #30363d; color: white; padding: 8px; border-radius: 6px; outline: none; font-family: var(--font-mono); font-size: 12px; }
        .copilot-input:focus { border-color: #00e5ff; }

        .markdown-body pre { background: #0d1117 !important; padding: 1em; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #30363d; }

        .hidden-ui { display: none !important; }
        .flex-ui { display: flex !important; }
        
        .generated-image-container { position: relative; margin-top: 12px; border-radius: 12px; overflow: hidden; border: 1px solid #00e5ff; box-shadow: 0 0 25px rgba(0, 229, 255, 0.3); }
        .generated-image-container img { width: 100%; display: block; animation: slideUpFade 0.5s ease-out; }
        .image-gen-error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #fca5a5; padding: 1rem; border-radius: 8px; margin-top: 10px; font-size: 0.8rem; text-align: center; }

        /* NEXUS ENGINE STYLES */
        #nexus-engine-overlay { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.96); display: none; flex-direction: column; backdrop-filter: blur(10px); }
        #nexus-engine-overlay.active { display: flex; }
        
        .nx-toolbar { height: 60px; background: #0f1115; border-bottom: 1px solid var(--nx-border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .nx-title { font-weight: 900; color: var(--accent-primary); letter-spacing: 3px; font-family: var(--font-header); text-shadow: 0 0 10px rgba(0, 229, 255, 0.5); }

        .nx-workspace { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 60px); }
        
        .nx-sidebar { width: 300px; background: #0d0f12; border-right: 1px solid #333; display: flex; flex-direction: column; overflow-y: auto; }
        .tool-section { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tool-title { font-size: 10px; text-transform: uppercase; color: #64748b; font-weight: bold; margin-bottom: 10px; letter-spacing: 1px; }
        
        .config-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .config-row label { font-size: 12px; color: #94a3b8; font-family: var(--font-mono); }
        .nx-input { background: #1a1d26; border: 1px solid #333; color: #00e5ff; padding: 6px 10px; border-radius: 4px; width: 100px; font-size: 12px; font-family: var(--font-mono); outline: none; transition: border-color 0.2s; }
        .nx-input:focus { border-color: #00e5ff; box-shadow: 0 0 10px rgba(0, 229, 255, 0.2); }

        .nx-viewport { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #050505; overflow: hidden; }
        canvas#nx-canvas { box-shadow: 0 0 40px rgba(0,0,0,0.8); border: 1px solid #333; cursor: crosshair; background-image: radial-gradient(#1a1d26 1px, transparent 1px); background-size: 20px 20px; }
        
        .nx-console-panel { width: 280px; background: #000; border-left: 1px solid #333; display: flex; flex-direction: column; font-family: var(--font-mono); font-size: 11px; }
        .console-output { flex: 1; padding: 15px; overflow-y: auto; color: #22c55e; }
        .console-output div { margin-bottom: 6px; word-break: break-all; text-shadow: 0 0 5px rgba(34, 197, 94, 0.4); }
        .console-input-area { padding: 15px; border-top: 1px solid #333; background: #0a0a0a; display: flex; gap: 8px; }
        .console-input { flex: 1; background: transparent; border: none; color: #22c55e; font-family: var(--font-mono); outline: none; }

        .nx-btn { background: rgba(0, 229, 255, 0.1); color: #00e5ff; border: 1px solid rgba(0, 229, 255, 0.3); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; font-family: var(--font-header); text-transform: uppercase; transition: all 0.2s; }
        .nx-btn:hover { background: rgba(0, 229, 255, 0.2); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .nx-btn-primary { background: #00e5ff; color: #000; border: none; }
        .nx-btn-primary:hover { background: #00c4d4; }
        .nx-btn-danger { color: #ff2a6d; border-color: rgba(255, 42, 109, 0.3); background: transparent; }
        .nx-btn-danger:hover { background: rgba(255, 42, 109, 0.1); box-shadow: 0 0 15px rgba(255, 42, 109, 0.2); }

        .nx-status { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #00e5ff; padding: 6px 16px; border-radius: 20px; font-size: 11px; font-family: var(--font-header); pointer-events: none; border: 1px solid rgba(0, 229, 255, 0.3); letter-spacing: 2px; z-index: 10; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative select-none text-sm">

    <div class="scanlines"></div>

    <!-- BOOT SCREEN -->
    <div id="boot-screen">
        <div class="loader-ring mb-8"></div>
        <h1 class="text-4xl font-header text-white tracking-[0.3em] animate-pulse drop-shadow-[0_0_20px_rgba(0,229,255,1)]">NEXUS <span class="text-cyan-500">AI</span></h1>
        <div class="mt-6 font-mono text-xs text-cyan-400 flex gap-2 items-center" id="boot-text">
            <span class="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></span> <span id="txt-init">INITIALIZING NEURAL NETWORK...</span>
        </div>
    </div>

    <!-- BACKGROUND CANVAS -->
    <canvas id="galaxy-canvas" class="fixed top-0 left-0 w-full h-full z-0 pointer-events-none"></canvas>

    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 z-20 glass-panel border-b border-cyan-500/20 h-16 flex items-center justify-between px-4 lg:px-6 bg-black/80">
        <div class="flex items-center gap-3">
            <div class="relative w-10 h-10 flex items-center justify-center group cursor-pointer">
                <div class="absolute inset-0 bg-cyan-600 rounded-lg blur opacity-40 group-hover:opacity-60 transition-opacity"></div>
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center border border-white/20 relative z-10 shadow-lg group-hover:scale-105 transition-transform">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
            </div>
            <div>
                <h1 class="font-header font-bold text-lg tracking-wider text-white hidden sm:block">NEXUS <span class="text-cyan-400">AI</span></h1>
                <div class="flex items-center gap-2 text-[10px] text-gray-400 font-mono mt-0.5">
                    <div id="api-status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500 shadow-[0_0_5px_red]"></div>
                    <span id="room-display" class="cursor-pointer hover:text-white transition-colors" onclick="forceReconnect()">OFFLINE</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleMedia()" class="p-2 rounded-full hover:bg-white/10 text-cyan-300 transition-colors glitch-hover" title="Media Deck">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </button>
            
            <button onclick="NX.toggleOverlay()" class="hidden sm:flex bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-300 border border-cyan-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all shadow-[0_0_10px_rgba(0,229,255,0.2)]">üéÆ ENGINE</button>
            
            <button onclick="shareApp()" class="p-2 rounded-full hover:bg-white/10 text-cyan-300 transition-colors glitch-hover hidden sm:flex" title="Airdrop / Share App">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
            </button>

            <button onclick="copySystemLog()" class="hidden sm:flex bg-white/5 hover:bg-white/10 text-gray-300 border border-white/10 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all items-center gap-1 hover:border-cyan-500/50 hover:text-white" title="Export System Log">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                <span id="btn-copy-log">COPY LOG</span>
            </button>

            <button onclick="toggleProfile()" class="hidden sm:flex bg-white/5 hover:bg-white/10 text-gray-300 border border-white/10 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all hover:border-cyan-500/50 hover:text-white">üë§ <span id="btn-profile">PROFILE</span></button>
            <button onclick="triggerKernelThought()" class="hidden sm:flex bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-300 border border-cyan-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all active-ring">üß† <span id="btn-kernel">KERNEL</span></button>
            <button onclick="toggleCodeEditor()" class="hidden sm:flex bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-300 border border-cyan-500/30 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all">üñã <span id="btn-ide">IDE</span></button>
            <button onclick="toggleAdmin()" id="admin-btn" class="p-2 rounded-full text-red-500/50 hover:text-red-500 hover:bg-red-900/20 transition-colors" title="System Console">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </button>
        </div>
    </header>

    <!-- MAIN CHAT AREA -->
    <main id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 z-10 scroll-smooth max-w-4xl mx-auto w-full space-y-4 mask-gradient">
    </main>

    <!-- INPUT AREA -->
    <div class="fixed bottom-0 left-0 w-full z-30 glass-panel border-t border-cyan-500/20 pt-3 pb-[calc(12px+var(--safe-bottom))] px-4 bg-black/90">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-end gap-2 bg-black/40 rounded-xl p-1.5 border border-white/5 input-glow transition-all duration-300 shadow-2xl">
                <button onclick="openKernelInput()" class="p-2.5 rounded-lg text-cyan-400 hover:bg-cyan-900/30 shrink-0 transition-colors" title="Ask AI">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </button>
                <input type="text" id="user-input" placeholder="Command: /ai [prompt], /img [prompt], /radio [genre], /game [name]..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 px-3 py-2.5 text-sm font-light tracking-wide">
                <button id="send-btn" class="p-2.5 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white shadow-lg shrink-0 transform active:scale-95 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- FLOATING MEDIA DECK -->
    <div id="media-deck" class="media-overlay glass-panel rounded-2xl overflow-hidden border border-cyan-500/30 shadow-[0_0_50px_rgba(0,229,255,0.3)]">
        <div class="p-3 border-b border-white/5 flex justify-between items-center bg-black/40">
            <span class="text-xs font-bold text-white font-header tracking-wider text-cyan-400" id="lbl-media-deck">MEDIA DECK</span>
            <button onclick="toggleMedia()" class="text-gray-400 hover:text-white transition-colors">‚úï</button>
        </div>
        <div class="p-4">
            <div class="flex gap-2 mb-4 p-1 bg-white/5 rounded-lg">
                <button onclick="switchMediaTab('video')" id="tab-btn-video" class="flex-1 py-1.5 text-[10px] font-bold rounded bg-white/10 text-cyan-300 shadow-sm border border-white/5 transition-all hover:bg-white/20">VIDEO</button>
                <button onclick="switchMediaTab('radio')" id="tab-btn-radio" class="flex-1 py-1.5 text-[10px] font-bold rounded text-gray-400 hover:text-white hover:bg-white/5 transition-all">RADIO</button>
            </div>
            
            <div id="tab-video">
                <div id="video-placeholder" class="bg-black/50 rounded-lg p-6 text-center border border-white/5 border-dashed mb-3">
                    <p class="text-xs text-gray-500 mb-2 font-mono" id="txt-uplink-status">Uplink Status: STANDBY</p>
                    <button id="btn-enable-video" onclick="startWebRTC()" class="text-[10px] bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded shadow-lg transition-all w-full border border-cyan-400/30 flex items-center justify-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> <span id="btn-init-video">INITIALIZE BROADCAST</span>
                    </button>
                    <button id="btn-disable-video" onclick="stopWebRTC()" class="hidden-ui text-[10px] bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded shadow-lg transition-all w-full border border-red-400/30 flex items-center justify-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> <span id="btn-term-video">TERMINATE LINK</span>
                    </button>
                </div>
                <div id="file-transfer-ui" class="hidden-ui mt-2 p-2 bg-white/5 rounded border border-white/10">
                    <div class="text-[9px] text-gray-400 mb-1 font-mono" id="lbl-p2p-files">P2P DATA CHANNEL</div>
                    <input type="file" id="p2p-file-input" class="hidden" onchange="handleFileSelect(this)">
                    <button onclick="document.getElementById('p2p-file-input').click()" class="w-full text-[10px] bg-cyan-900/40 hover:bg-cyan-900/60 text-cyan-300 py-2 rounded border border-cyan-500/30 flex items-center justify-center gap-2 transition-colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span id="btn-send-file">SEND FILE</span>
                    </button>
                    <div id="transfer-progress" class="mt-2 hidden">
                        <div class="h-1 w-full bg-gray-700 rounded overflow-hidden">
                            <div id="progress-bar" class="h-full bg-cyan-500 w-0 transition-all duration-200"></div>
                        </div>
                        <div class="text-[8px] text-cyan-400 mt-1 text-right" id="transfer-status">0%</div>
                    </div>
                </div>
                <div id="video-grid" class="hidden video-grid"></div>
            </div>
            
            <div id="tab-radio" class="hidden">
                <div class="relative mb-2">
                    <input type="text" id="radio-search-input" placeholder="Search stations..." 
                           class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:border-cyan-500 outline-none font-mono placeholder-gray-600">
                    <div class="absolute right-2 top-2 text-gray-500 text-[10px]">üîç</div>
                </div>
                <div class="text-[10px] text-gray-400 font-mono mb-2" id="txt-scan-freq">>> CONNECTING TO FREQUENCY...</div>
                <div id="radio-genres-container" class="radio-genres"><div class="text-center w-full text-gray-500 text-[9px] py-2">LOADING GENRES...</div></div>
                <div id="radio-stations-container" class="station-list"><div class="text-center text-gray-500 text-[9px] py-4">SELECT A GENRE OR SEARCH</div></div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="hidden-ui fixed bottom-20 right-4 left-4 md:left-auto md:w-80 glass-panel rounded-xl border border-red-500/30 p-5 z-50 shadow-2xl bg-black/90">
        <h3 class="text-cyan-400 font-header text-xs font-bold mb-4 uppercase flex justify-between items-center">
            <span id="lbl-sys-console">System Console</span>
            <span class="text-[9px] bg-cyan-900/50 px-2 py-0.5 rounded text-cyan-300">GEN 2</span>
        </h3>
        <div class="space-y-4">
            <div>
                <label class="text-[9px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">AI PROVIDER</label>
                <select id="provider-select" onchange="updateProviderSettings()" class="w-full bg-black/50 border border-white/10 rounded p-2.5 text-white text-xs focus:border-cyan-500 outline-none font-mono transition-colors">
                    <option value="groq">Groq (Fast/Free)</option>
                    <option value="deepseek">DeepSeek (Official)</option>
                    <option value="zhipu">Zhipu AI (GLM)</option>
                    <option value="pollinations">Pollinations (Free/Open)</option>
                </select>
            </div>
            <div>
                <label class="text-[9px] text-gray-500 uppercase font-bold tracking-wider mb-1 block" id="lbl-api-key">API Key</label>
                <input type="password" id="api-key-input" class="w-full bg-black/50 border border-white/10 rounded p-2.5 text-white text-xs focus:border-cyan-500 outline-none font-mono transition-colors" placeholder="Enter Key...">
            </div>
            <div>
                <label class="text-[9px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">NEURAL MODEL</label>
                <select id="model-select" class="w-full bg-black/50 border border-white/10 rounded p-2.5 text-white text-xs focus:border-cyan-500 outline-none font-mono transition-colors"></select>
            </div>
            
            <!-- POLLINATIONS IMAGE MODEL SELECTOR -->
            <div style="margin-top: 15px;">
                <label class="text-[9px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">IMAGE ENGINE MODEL</label>
                <select id="pollinations-img-model" onchange="saveImgModel()" class="w-full bg-black/50 border border-white/10 rounded p-2.5 text-white text-xs focus:border-purple-500 outline-none font-mono transition-colors">
                    <option value="flux">Flux (Realistic)</option>
                    <option value="turbo">Turbo (Fast)</option>
                    <option value="sdxl">SDXL (Standard)</option>
                    <option value="juggernaut">Juggernaut XL</option>
                </select>
            </div>

            <button onclick="saveApiKey()" class="w-full bg-cyan-900/40 hover:bg-cyan-800/60 text-cyan-200 text-[10px] font-bold py-2.5 rounded border border-cyan-500/30 transition-all hover:shadow-[0_0_15px_rgba(0,229,255,0.3)]" id="btn-save-api">SAVE & RECONNECT</button>
            <hr class="border-white/10">
            <button onclick="resetSystem()" class="w-full bg-white/5 hover:bg-red-900/20 text-white text-[10px] font-bold py-2 rounded transition-colors border border-white/10 hover:border-red-500/50" id="btn-reset-sys">EMERGENCY SYSTEM RESET</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="hidden-ui fixed inset-0 z-[60] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl border border-cyan-500/30 max-w-sm w-full mx-4 text-center shadow-[0_0_60px_rgba(0,229,255,0.3)]">
            <h3 class="text-white font-header font-bold mb-6 text-lg tracking-wider" id="lbl-user-id">USER IDENTITY</h3>
            <div class="space-y-6">
                <div class="flex flex-col items-center gap-3">
                    <div id="profile-avatar-preview" class="w-24 h-24 rounded-full bg-gray-800 border-2 border-cyan-500 overflow-hidden flex items-center justify-center text-3xl shadow-[0_0_20px_rgba(0,229,255,0.5)] relative group">
                        üë§
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                            <span class="text-xs text-white">CHANGE</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('avatar-upload').click()" class="text-[10px] text-cyan-300 font-bold tracking-widest hover:text-white transition-colors border-b border-cyan-500/30 pb-0.5" id="btn-up-avatar">UPLOAD AVATAR</button>
                </div>
                <div class="text-left">
                    <label class="block text-xs text-cyan-400 mb-1 font-mono font-bold" id="lbl-codename">CODENAME</label>
                    <input type="text" id="edit-name" class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-cyan-500 outline-none transition-colors font-mono">
                </div>
                <div class="text-left space-y-3 pt-2 border-t border-white/10">
                    <label class="block text-[10px] text-gray-400 font-bold uppercase" id="lbl-settings">SETTINGS</label>
                    <div class="flex justify-between items-center bg-black/20 p-2 rounded">
                        <span class="text-xs text-gray-300" id="lbl-language">Language</span>
                        <select id="lang-select" onchange="changeLanguage(this.value)" class="bg-black/50 border border-white/10 text-xs text-white rounded px-2 py-1 outline-none">
                            <option value="en">English</option>
                            <option value="lt">Lietuvi≈≥</option>
                        </select>
                    </div>
                    <button onclick="generateInviteLink()" class="w-full bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-300 text-[10px] font-bold py-2 rounded border border-cyan-500/30 transition-all flex items-center justify-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        <span id="btn-gen-invite">GENERATE INVITE LINK</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="saveProfile()" class="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-xs font-bold py-2.5 rounded-lg shadow-lg transition-all transform hover:-translate-y-0.5" id="btn-save-id">SAVE ID</button>
                <button onclick="toggleProfile()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-gray-300 text-xs font-bold py-2.5 rounded-lg border border-white/10 transition-all" id="btn-cancel">CANCEL</button>
            </div>
        </div>
    </div>
    <input type="file" id="avatar-upload" class="hidden" accept="image/*">

    <!-- CODE EDITOR OVERLAY -->
    <div id="code-editor-overlay">
        <div class="h-12 border-b border-white/10 flex items-center justify-between px-4 bg-[#0d1117]">
            <div class="flex gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500/80"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/80"></div>
            </div>
            <span class="text-xs text-gray-400 font-mono tracking-widest">SYSTEM_EDITOR_V6.0 [NEXUS]</span>
            <div class="flex gap-2">
                <button onclick="toggleRepoSettings()" class="text-[9px] bg-gray-800 hover:bg-gray-700 text-white px-2 py-1 rounded border border-gray-600 flex items-center gap-1"><span>‚öôÔ∏è REPO SETTINGS</span></button>
                <button onclick="pushToRepo()" class="text-[9px] bg-green-900 hover:bg-green-800 text-white px-2 py-1 rounded border border-green-600 flex items-center gap-1"><span>COMMIT & PUSH</span></button>
                <button onclick="resetGamePreview()" class="text-[9px] bg-red-900 hover:bg-red-800 text-white px-2 py-1 rounded border border-red-600 flex items-center gap-1"><span>RESET GAME</span></button>
                <button onclick="toggleCodeEditor()" class="text-white hover:text-red-400 font-bold text-lg px-2">√ó</button>
            </div>
        </div>
        
        <div id="ide-repo-settings" class="hidden-ui bg-black border-b border-white/10 p-3 grid grid-cols-2 md:grid-cols-4 gap-2 items-end">
            <div><label class="text-[8px] text-gray-500 uppercase">GitHub Token</label><input type="password" id="gh-token" placeholder="ghp_..." class="w-full bg-[#0d1117] border border-white/20 text-white text-[10px] p-1 rounded outline-none"></div>
            <div><label class="text-[8px] text-gray-500 uppercase">Owner</label><input type="text" id="gh-owner" placeholder="username" class="w-full bg-[#0d1117] border border-white/20 text-white text-[10px] p-1 rounded outline-none"></div>
            <div><label class="text-[8px] text-gray-500 uppercase">Repo Name</label><input type="text" id="gh-repo" placeholder="my-repo" class="w-full bg-[#0d1117] border border-white/20 text-white text-[10px] p-1 rounded outline-none"></div>
            <div><label class="text-[8px] text-gray-500 uppercase">File Path</label><input type="text" id="gh-path" placeholder="index.html" class="w-full bg-[#0d1117] border border-white/20 text-white text-[10px] p-1 rounded outline-none"></div>
            <div class="col-span-2 md:col-span-4 mt-2 pt-2 border-t border-white/10 flex justify-between items-center">
                <div class="flex gap-2 items-center">
                    <input type="text" id="load-repo-input" placeholder="owner/repo (e.g. vercel/next.js)" class="bg-[#0d1117] border border-white/20 text-white text-[10px] p-1 rounded outline-none w-64">
                    <button onclick="installRepo()" class="bg-cyan-900 hover:bg-cyan-800 text-white text-[9px] px-3 py-1 rounded border border-cyan-500">INSTALL / CLONE</button>
                </div>
                <div class="text-[9px] text-gray-500 font-mono" id="file-sha-display">SHA: --</div>
            </div>
        </div>

        <div class="editor-body">
            <div class="editor-col"><textarea id="code-area" spellcheck="false" placeholder="// Write code here..."></textarea></div>
            <div class="editor-col" id="preview-area">
                <div class="absolute top-2 right-2 z-10 flex gap-2"><button onclick="runCode()" class="bg-green-600 text-white text-[9px] px-2 py-1 rounded font-bold" id="btn-run-preview">RUN PREVIEW</button></div>
                <iframe id="preview-frame" title="Preview"></iframe>
            </div>
            <div class="editor-col" id="copilot-panel">
                <div class="copilot-header"><span>COPILOT AI</span><span class="text-[9px] text-gray-400 font-normal" id="copilot-status">READY</span></div>
                <div class="copilot-chat" id="copilot-chat-log"><div class="text-gray-500 italic text-[10px] mb-2">I can Fix, Mutate, or Explain your code.</div></div>
                <div class="border-t border-white/10 p-2 bg-[#050505]">
                    <button onclick="triggerAutoFix()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white text-[9px] font-bold py-2 rounded flex items-center justify-center gap-2 mb-2 shadow-[0_0_10px_rgba(0,229,255,0.3)]"><span>ü©π AUTO-FIX / MUTATE CODE</span></button>
                </div>
                <div class="copilot-input-area"><input type="text" id="copilot-input" class="copilot-input" placeholder="Ask about code..."><button onclick="askCopilot()" class="text-cyan-400 hover:text-white px-2">‚û§</button></div>
            </div>
        </div>
    </div>

    <!-- NEXUS ENGINE V2 OVERLAY -->
    <div id="nexus-engine-overlay">
        <div class="nx-toolbar">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-cyan-500 shadow-[0_0_10px_#00e5ff] animate-pulse"></div>
                <div class="nx-title">NEXUS ENGINE <span style="font-size:10px; opacity:0.6; color:#fff">V2.0</span></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="NX.toggleConsole()" class="nx-btn" style="border-color:#333; color:#fff;">CONSOLE</button>
                <button onclick="NX.toggle3D()" class="nx-btn" id="btn-3d" style="border-color:#333; color:#fff;">2D VIEW</button>
                <button onclick="NX.runGame()" class="nx-btn nx-btn-primary" id="btn-run">RUN GAME</button>
                <button onclick="NX.stopGame()" class="nx-btn nx-btn-danger hidden" id="btn-stop">STOP</button>
                <button onclick="NX.toggleOverlay()" class="nx-btn nx-btn-danger">CLOSE</button>
            </div>
        </div>

        <div class="nx-workspace">
            <!-- LEFT: Entity Creator -->
            <aside class="nx-sidebar">
                <div class="tool-section">
                    <div class="tool-title">1. Entity Fabricator</div>
                    <div class="config-row">
                        <label>Type</label>
                        <select id="nx-type" class="nx-input" style="width:100%" onchange="NX.updatePreview()">
                            <option value="player">Hero (Player)</option>
                            <option value="enemy">Enemy (Drone)</option>
                            <option value="wall">Block (Wall)</option>
                            <option value="platform">Platform</option>
                            <option value="coin">Item (Coin)</option>
                            <option value="spike">Hazard (Spike)</option>
                            <option value="goal">Portal (Goal)</option>
                        </select>
                    </div>
                    
                    <!-- Physics / Logic Props -->
                    <div id="logic-props">
                        <div class="config-row"><label>Width</label><input type="number" id="nx-w" class="nx-input" value="30"></div>
                        <div class="config-row"><label>Height</label><input type="number" id="nx-h" class="nx-input" value="30"></div>
                        <div class="config-row"><label>Speed</label><input type="number" id="nx-speed" class="nx-input" value="2"></div>
                        <div class="config-row"><label>Gravity</label><input type="number" id="nx-grav" class="nx-input" value="0.5"></div>
                        <div class="config-row"><label>Color</label><input type="color" id="nx-color" class="nx-input" style="width:40px; padding:0;" value="#00e5ff"></div>
                    </div>
                    
                    <button onclick="NX.placeEntityCenter()" class="nx-btn nx-btn-primary" style="width:100%; margin-top:10px;">
                        Place in Center
                    </button>
                    <div style="font-size:10px; color:#666; text-align:center; margin-top:5px;">
                        (Or Click on Canvas)
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-title">2. Neural Logic</div>
                    <select id="nx-behavior" class="nx-input" style="width:100%; margin-bottom:10px;">
                        <option value="idle">Idle (Do Nothing)</option>
                        <option value="patrol">Patrol (Move Left/Right)</option>
                        <option value="chase">Chase (Follow Player)</option>
                        <option value="bounce">Bounce (Hop)</option>
                    </select>
                    <div style="font-size:10px; color:#666;">
                        Apply behavior to newly created Enemies or Players.
                    </div>
                </div>

                <div style="margin-top:auto; padding:15px; border-top:1px solid #333;">
                    <button onclick="NX.clearLevel()" class="nx-btn nx-btn-danger" style="width:100%">CLEAR LEVEL DATA</button>
                </div>
            </aside>

            <!-- CENTER: Viewport -->
            <section class="nx-viewport">
                <canvas id="nx-canvas" width="800" height="600"></canvas>
                <div id="nx-status" class="nx-status">DESIGN MODE</div>
            </section>

            <!-- RIGHT: Console & AI -->
            <aside class="nx-console-panel hidden" id="nx-right-panel">
                <div class="tool-title" style="padding:10px; background:#0a0c0e; border-bottom:1px solid #333; color:#22c55e;">TERMINAL OUTPUT</div>
                <div class="console-output" id="nx-console-out">
                    <div>> System Ready.</div>
                    <div>> Type 'help' for commands.</div>
                </div>
                <div class="console-input-area">
                    <span style="color:#666">></span>
                    <input type="text" id="nx-console-in" class="console-input" placeholder="Command..." autocomplete="off">
                </div>

                <div style="padding:15px; border-top:1px solid #333; background:#0d0f12;">
                    <div class="tool-title" style="margin-bottom:10px; color:#00e5ff">AI GENERATOR</div>
                    <textarea id="nx-ai-prompt" class="console-input" style="width:100%; height:60px; margin-bottom:10px; background:#1a1d26; border:1px solid #333; color:#e2e8f0; border-radius:4px; padding:8px; resize:none;" placeholder="e.g. Create a castle level with guards..."></textarea>
                    <button onclick="NX.generateLevelAI()" class="nx-btn nx-btn-primary" style="width:100%;">GENERATE LEVEL</button>
                </div>
            </aside>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION & STATE --- */
        // RELIABLE LOCAL FALLBACK DATABASE
        const STATIONS_DB = [
            { name: "Lofi Girl - Beats to Relax/Study to", url: "https://streams.ilovemusic.com/lofigirl.mp3", genre: "LoFi" },
            { name: "BBC Radio 1", url: "http://stream.live.vc.bbcmedia.co.uk/bbc_radio_one/bbc_radio_one.mp3", genre: "News" },
            { name: "Classical FM", url: "http://stream.zeno.fm/fm3y54887", genre: "Classical" },
            { name: "Deep House Radio", url: "https://stream.zeno.fm/0rQxaWZz7rUw8V", genre: "House" },
            { name: "Synthwave 24/7", url: "https://stream.zeno.fm/s5w619d7y3uv", genre: "Synthwave" },
            { name: "Absolute Classic Rock", url: "https://stream.zeno.fm/f3wv19p5y3uv", genre: "Rock" },
            { name: "Ambient Sleeping Pill", url: "https://stream.zeno.fm/0rQxaWZz7rUw8V", genre: "Ambient" },
            { name: "Techno Base", url: "https://stream.zeno.fm/2026914864h264", genre: "Techno" }
        ];

        const PROVIDERS = {
            groq: { url: "https://api.groq.com/openai/v1/chat/completions", models: [{ id: "llama-3.3-70b-versatile", name: "Llama 3.3 70B (Fastest)" }, { id: "mixtral-8x7b-32768", name: "Mixtral 8x7b" }, { id: "gemma2-9b-it", name: "Gemma 2 9B" }], keyLabel: "Groq API Key" },
            deepseek: { url: "https://api.deepseek.com/chat/completions", models: [{ id: "deepseek-chat", name: "DeepSeek V3" }, { id: "deepseek-coder", name: "DeepSeek Coder" }], keyLabel: "DeepSeek API Key" },
            zhipu: { url: "https://open.bigmodel.cn/api/paas/v4/chat/completions", models: [{ id: "glm-4", name: "GLM-4" }, { id: "glm-4-flash", name: "GLM-4 Flash" }], keyLabel: "Zhipu API Key" },
            pollinations: { url: "https://text.pollinations.ai/openai/v1/chat/completions", models: [{ id: "openai", name: "GPT-4o Mini (Pollinations)" }, { id: "qwen", name: "Qwen 2.5 (Pollinations)" }], keyLabel: "API Key (Optional - usually free)" }
        };

        let currentProvider = localStorage.getItem('nexus_provider') || 'groq';
        let currentModel = localStorage.getItem('nexus_model') || 'llama-3.3-70b-versatile';
        let currentImgModel = localStorage.getItem('nexus_img_model') || 'flux';
        let apiKeys = JSON.parse(localStorage.getItem('nexus_api_keys') || '{}');
        let ghToken = localStorage.getItem('nexus_gh_token') || '';
        
        // UPDATED SYSTEM MANIFEST
        const SYSTEM_MANIFEST_EN = "You are Nexus AI v6.0. CRITICAL INSTRUCTION: If user asks for an image, picture, photo, drawing, or visual representation (e.g. 'draw a cat', 'show me mars'), do NOT describe it. Instead, reply ONLY with this specific format: [GENERATE_IMAGE: your exact prompt here]. If user asks for RADIO stations... Output ONLY a valid JSON array of objects. Schema: [{name: 'Station Name', url: 'http://stream.mp3', genre: 'Genre'}]. Otherwise, answer normally.";
        
        let currentLang = localStorage.getItem('nexus_lang') || 'en';
        let userProfile = { name: localStorage.getItem('nexus_username') || 'User_' + Math.floor(Math.random() * 9999), avatar: localStorage.getItem('nexus_avatar') || "üë§" };
        let tempAvatarData = null;
        let currentRoom = "public"; 
        let mqttClient = null;
        let currentFileSHA = null; 
        let isTabActive = true; 

        // FALLBACK BROKER LIST
        const ALL_BROKERS = [
            { name: "EMQX (Secure)", host: "broker.emqx.io", port: 8084, path: "/mqtt", ssl: true },
            { name: "Mosquitto (Insecure)", host: "test.mosquitto.org", port: 8080, path: "/mqtt", ssl: false },
            { name: "HiveMQ (Insecure)", host: "broker.hivemq.com", port: 8000, path: "/mqtt", ssl: false }
        ];
        let currentBrokerIdx = 0;
        let mqttReconnectTimeout = null;

        /* --- NEXUS ENGINE V2 LOGIC --- */
        const NX = {
            active: false,
            mode: 'DESIGN', 
            entities: [],
            particles: [],
            ctx: null,
            canvas: null,
            lastTime: 0,
            keys: {},
            view3D: false,
            selectedTool: { type: 'player', w: 30, h: 30, speed: 2, color: '#00e5ff', behavior: 'idle', gravity: 0.5 },
            playerRef: null,
            
            toggleOverlay: function() {
                const overlay = document.getElementById('nexus-engine-overlay');
                if(overlay.classList.contains('active')) {
                    overlay.classList.remove('active');
                    this.active = false;
                    this.stopGame();
                } else {
                    overlay.classList.add('active');
                    if(!this.canvas) this.init();
                    this.active = true;
                    this.canvas.focus();
                }
            },

            init: function() {
                this.canvas = document.getElementById('nx-canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.canvas.addEventListener('mousedown', (e) => this.handleInput(e));
                document.addEventListener('keydown', (e) => {
                    if(this.active) {
                        this.keys[e.key] = true;
                        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' ','w','a','s','d'].includes(e.key)) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }
                });
                document.addEventListener('keyup', (e) => {
                    if(this.active) this.keys[e.key] = false;
                });

                document.getElementById('nx-console-in').addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') this.handleConsole(e.target.value);
                });

                this.active = true;
                this.loop();
            },

            toggleConsole: function() {
                const p = document.getElementById('nx-right-panel');
                p.classList.toggle('hidden');
            },

            toggle3D: function() {
                this.view3D = !this.view3D;
                const btn = document.getElementById('btn-3d');
                btn.innerText = this.view3D ? "3D VIEW (SIM)" : "2D VIEW";
            },

            handleInput: function(e) {
                if(this.mode !== 'DESIGN') return;

                const rect = this.canvas.getBoundingClientRect();
                const scaleX = 800 / rect.width;
                const scaleY = 600 / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                const clicked = this.entities.slice().reverse().find(ent => 
                    x >= ent.x && x <= ent.x + ent.w && y >= ent.y && y <= ent.y + ent.h
                );

                if(clicked) {
                    if(confirm(`Delete ${clicked.type}?`)) {
                        this.entities = this.entities.filter(en => en !== clicked);
                        this.log(`Deleted entity at ${Math.round(clicked.x)},${Math.round(clicked.y)}`);
                    }
                } else {
                    this.spawnEntity(x, y);
                }
            },

            placeEntityCenter: function() {
                const x = 400 - this.selectedTool.w / 2;
                const y = 300 - this.selectedTool.h / 2;
                this.spawnEntity(x, y);
            },

            spawnEntity: function(x, y) {
                const type = document.getElementById('nx-type').value;
                const w = parseFloat(document.getElementById('nx-w').value) || 30;
                const h = parseFloat(document.getElementById('nx-h').value) || 30;
                const speed = parseFloat(document.getElementById('nx-speed').value) || 2;
                const grav = parseFloat(document.getElementById('nx-grav').value) || 0.5;
                const color = document.getElementById('nx-color').value;
                const behavior = document.getElementById('nx-behavior').value;

                const ent = {
                    id: Date.now() + Math.random(),
                    type, x, y, w, h, speed, color, behavior,
                    dx: 0, dy: 0, grounded: false,
                    startX: x, patrolDir: 1
                };

                if(type === 'player') {
                    this.entities = this.entities.filter(e => e.type !== 'player');
                }

                this.entities.push(ent);
                this.log(`Spawned ${type} at ${Math.round(x)},${Math.round(y)}`);
                this.createParticles(x + w/2, y + h/2, '#fff', 10);
            },

            updateLogic: function(ent, dt) {
                if(ent.behavior === 'patrol') {
                    ent.x += ent.speed * ent.patrolDir * 0.05;
                    if(Math.abs(ent.x - ent.startX) > 100) ent.patrolDir *= -1;
                }
                if(ent.behavior === 'chase' && this.playerRef) {
                    const dx = this.playerRef.x - ent.x;
                    const dy = this.playerRef.y - ent.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 200) {
                        ent.x += (dx / dist) * ent.speed;
                        ent.y += (dy / dist) * ent.speed;
                    }
                }
                if(ent.behavior === 'bounce') {
                    if(ent.grounded) {
                        ent.dy = -10;
                        ent.grounded = false;
                    }
                }
            },

            runGame: function() {
                const player = this.entities.find(e => e.type === 'player');
                if(!player) { alert("Please place a 'Hero' first!"); return; }
                
                this.mode = 'PLAY';
                this.playerRef = { ...player }; 
                
                this.entities.forEach(e => {
                    if(e.type !== 'player') {
                        e.startX = e.x; 
                    }
                });

                document.getElementById('btn-run').classList.add('hidden');
                document.getElementById('btn-stop').classList.remove('hidden');
                document.getElementById('nx-status').innerText = "RUNNING - WASD to Move";
                document.getElementById('nx-status').style.color = "#05ffa1";
                this.canvas.focus();
            },

            stopGame: function() {
                this.mode = 'DESIGN';
                this.playerRef = null;
                document.getElementById('btn-run').classList.remove('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
                document.getElementById('nx-status').innerText = "DESIGN MODE";
                document.getElementById('nx-status').style.color = "#00e5ff";
            },

            loop: function() {
                if(!this.active) return;
                requestAnimationFrame(() => this.loop());
                
                const now = performance.now();
                const dt = now - this.lastTime;
                this.lastTime = now;

                this.ctx.fillStyle = '#050505';
                this.ctx.fillRect(0, 0, 800, 600);

                if(this.mode === 'PLAY') {
                    this.updatePhysics(dt);
                }

                this.entities.forEach(ent => this.drawEntity(ent));
                this.updateParticles(dt);
            },

            updatePhysics: function(dt) {
                const p = this.playerRef;
                if(!p) return;

                if(this.keys['ArrowLeft'] || this.keys['a']) p.dx = -p.speed;
                else if(this.keys['ArrowRight'] || this.keys['d']) p.dx = p.speed;
                else p.dx = 0;

                if((this.keys['ArrowUp'] || this.keys['w']) && p.grounded) {
                    p.dy = -12; 
                    p.grounded = false;
                }

                p.dy += p.gravity || 0.5;
                p.x += p.dx;
                p.y += p.dy;
                p.grounded = false;

                if(p.x < 0) p.x = 0;
                if(p.x > 800 - p.w) p.x = 800 - p.w;

                this.entities.forEach(ent => {
                    if(ent === p || ent.type === 'player') return;
                    
                    if(p.x < ent.x + ent.w && p.x + p.w > ent.x && 
                       p.y < ent.y + ent.h && p.y + p.h > ent.y) {
                        
                        if(p.dy > 0 && p.y + p.h - p.dy <= ent.y) {
                            p.y = ent.y - p.h;
                            p.dy = 0;
                            p.grounded = true;
                        }
                        
                        if(ent.type === 'coin') {
                            ent.visible = false; 
                            this.createParticles(ent.x, ent.y, ent.color, 20);
                        }
                        if(ent.type === 'enemy') {
                            this.stopGame();
                            alert("Game Over!");
                        }
                    }
                });

                if(p.y > 600) {
                    this.stopGame();
                    alert("Fell into void.");
                }
            },

            drawEntity: function(ent) {
                if(ent.visible === false) return;
                
                const ctx = this.ctx;
                const x = ent.x;
                const y = ent.y;
                const w = ent.w;
                const h = ent.h;
                const color = ent.color;

                if(!this.view3D) {
                    ctx.fillStyle = color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = color;
                    if(ent.type === 'player') {
                        ctx.fillRect(x, y, w, h);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(x + w/2, y + 5, 6, 4);
                    } else if (ent.type === 'enemy') {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + w/2, y + h);
                        ctx.lineTo(x + w, y);
                        ctx.fill();
                    } else if (ent.type === 'coin') {
                        ctx.beginPath();
                        ctx.arc(x + w/2, y + h/2, w/2, 0, Math.PI*2);
                        ctx.fill();
                    } else {
                        ctx.fillRect(x, y, w, h);
                    }
                    ctx.shadowBlur = 0;
                } else {
                    ctx.fillStyle = '#000'; 
                    ctx.fillRect(x + 5, y + 5, w, h);
                    
                    ctx.fillStyle = color; 
                    ctx.fillRect(x, y, w, h);
                    
                    ctx.fillStyle = 'rgba(255,255,255,0.2)'; 
                    ctx.fillRect(x, y, w, h/3);
                }

                if(this.mode === 'DESIGN' && ent.behavior !== 'idle') {
                    ctx.fillStyle = 'white';
                    ctx.font = '10px monospace';
                    ctx.fillText(ent.behavior, x, y - 5);
                }
            },

            createParticles: function(x, y, color, count) {
                for(let i=0; i<count; i++) {
                    this.particles.push({
                        x, y,
                        dx: (Math.random()-0.5)*5,
                        dy: (Math.random()-0.5)*5,
                        life: 1.0,
                        color
                    });
                }
            },

            updateParticles: function(dt) {
                const ctx = this.ctx;
                for(let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.x += p.dx;
                    p.y += p.dy;
                    p.life -= 0.05;
                    
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 3, 3);
                    
                    if(p.life <= 0) this.particles.splice(i, 1);
                }
                ctx.globalAlpha = 1.0;
            },

            clearLevel: function() {
                this.entities = [];
                this.log("Level Cleared.");
            },

            log: function(msg) {
                const out = document.getElementById('nx-console-out');
                const div = document.createElement('div');
                div.innerText = `> ${msg}`;
                out.appendChild(div);
                out.scrollTop = out.scrollHeight;
            },

            handleConsole: function(cmd) {
                const el = document.getElementById('nx-console-in');
                el.value = '';
                const parts = cmd.split(' ');
                const command = parts[0].toLowerCase();

                this.log(cmd);

                if(command === 'help') {
                    this.log("Commands: spawn, clear, list, run, stop");
                }
                else if(command === 'clear') this.clearLevel();
                else if(command === 'run') this.runGame();
                else if(command === 'stop') this.stopGame();
                else if(command === 'spawn') {
                    if(parts[1]) {
                        document.getElementById('nx-type').value = parts[1];
                        this.placeEntityCenter();
                    }
                }
                else {
                    this.log("Unknown command.");
                }
            },

            generateLevelAI: async function() {
                const prompt = document.getElementById('nx-ai-prompt').value;
                if(!prompt) return;
                
                this.log("Contacting AI Architect...");
                
                try {
                    const key = apiKeys[currentProvider];
                    if(!key) throw new Error("API Key Missing");
                    
                    const res = await fetch(PROVIDERS[currentProvider].url, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: currentModel,
                            messages: [
                                {role: "system", content: "Generate JSON game data. Output ONLY an array of objects. Schema: [{type,x,y,w,h,color,behavior}]"},
                                {role: "user", content: `Create a 2D platformer level: ${prompt}`}
                            ],
                            temperature: 0.7,
                            max_tokens: 1000
                        })
                    });
                    const data = await res.json();
                    const content = data.choices[0].message.content;
                    
                    const jsonMatch = content.match(/\[.*\]/s);
                    if(jsonMatch) {
                        const aiEntities = JSON.parse(jsonMatch[0]);
                        this.entities = []; 
                        
                        aiEntities.forEach(e => {
                            this.spawnEntity(e.x || 400, e.y || 300);
                            const last = this.entities[this.entities.length-1];
                            if(e.w) last.w = e.w;
                            if(e.h) last.h = e.h;
                            if(e.color) last.color = e.color;
                            if(e.behavior) last.behavior = e.behavior;
                            last.dx = 0; last.dy = 0; 
                        });
